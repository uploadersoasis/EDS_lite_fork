name: Android CI - Build and Publish SELF-SIGNED RELEASE APK

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # --- HACK: 1. Generate a temporary Keystore for signing ---
    - name: Generate Temporary Keystore
      run: |
        echo "Creating temporary keystore for CI signing..."
        keytool -genkey -v \
        -keystore temp.keystore \
        -alias temp-alias \
        -keyalg RSA \
        -keysize 2048 \
        -validity 10000 \
        -dname "CN=CI Tester, OU=Dev, O=CI/CD, C=US" \
        -storepass temp-pass \
        -keypass temp-pass
      shell: bash

    - name: Build RELEASE AAB and Unsigned APK with Gradle
      run: ./gradlew assembleRelease --warning-mode all

    # --- DIAGNOSTIC STEP (Should be removed later) ---
    - name: List ALL APK Files for Path Diagnosis
      run: |
        echo "Searching for ALL generated .apk files..."
        find ${{ github.workspace }} -name "*.apk"
        echo "--- End of APK search results ---"
      shell: bash
    # ----------------------------------------------------

    # --- HACK: 2. Find the build tools and optimize (zipalign) ---
    - name: Find and Optimize Unsigned APK (zipalign)
      id: zipalign_apk
      run: |
        # Find the build tools path (e.g., /usr/local/lib/android/sdk/build-tools/34.0.0)
        BUILD_TOOLS_DIR=$(find /usr/local/lib/android/sdk/build-tools/ -maxdepth 1 -type d | sort -V | tail -n 1)
        if [ -z "$BUILD_TOOLS_DIR" ]; then
          echo "::error::Could not locate Android build-tools directory."
          exit 1
        fi
        
        # --- FIX: Broaden the search to any file ending in -unsigned.apk ---
        UNSIGNED_APK_PATH=$(find ${{ github.workspace }} -name "*-unsigned.apk" -print -quit)
        if [ -z "$UNSIGNED_APK_PATH" ]; then
          echo "::error::Could not find unsigned release APK."
          exit 1
        fi

        OPTIMIZED_APK_PATH=$(dirname "$UNSIGNED_APK_PATH")/app-release-optimized.apk
        
        echo "Optimizing: $UNSIGNED_APK_PATH to $OPTIMIZED_APK_PATH"
        # Optimize (zipalign) the unsigned APK
        "$BUILD_TOOLS_DIR/zipalign" -v 4 "$UNSIGNED_APK_PATH" "$OPTIMIZED_APK_PATH"
        
        echo "OPTIMIZED_APK_PATH=$OPTIMIZED_APK_PATH" >> $GITHUB_OUTPUT
      shell: bash

    # --- HACK: 3. Sign the optimized APK (apksigner) ---
    - name: Sign Android Release with Temporary Keystore
      id: sign_apk
      run: |
        BUILD_TOOLS_DIR=$(find /usr/local/lib/android/sdk/build-tools/ -maxdepth 1 -type d | sort -V | tail -n 1)
        SIGNED_APK_PATH=$(dirname "${{ steps.zipalign_apk.outputs.OPTIMIZED_APK_PATH }}")/app-release-signed.apk
        
        echo "Signing: ${{ steps.zipalign_apk.outputs.OPTIMIZED_APK_PATH }} to $SIGNED_APK_PATH"
        # Sign the optimized APK with the temporary keystore
        "$BUILD_TOOLS_DIR/apksigner" sign \
          --ks temp.keystore \
          --ks-key-alias temp-alias \
          --ks-pass pass:temp-pass \
          --key-pass pass:temp-pass \
          --out "$SIGNED_APK_PATH" \
          "${{ steps.zipalign_apk.outputs.OPTIMIZED_APK_PATH }}"
        
        echo "SIGNED_APK_PATH=$SIGNED_APK_PATH" >> $GITHUB_OUTPUT
      shell: bash

    - name: Upload Final Signed Release APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: eds-lite-signed-release-apk
        # Use the path to the final signed APK
        path: ${{ steps.sign_apk.outputs.SIGNED_APK_PATH }}
        retention-days: 7
